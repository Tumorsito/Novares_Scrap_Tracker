// Inicializar ejemplos de piezas por línea si no existen
window.piezasEjemplo = {
  NUEVO: [
    { nombre: 'LABEL ROLL (LABEL00051)', cantidad: 0 },
    { nombre: 'SPLIT INSERT - LIMITER (CS48175.A)', cantidad: 0 },
    { nombre: 'ROLL RIBBON (INKTHERM00107)', cantidad: 0 },
    { nombre: 'O-RING FORD BC3Q-8527-CA (CS44105.A)', cantidad: 0 },
    { nombre: 'PIP SEAL FORD # BC3Q-6A632-AA (CS3539.A)', cantidad: 0 },
    { nombre: 'CHECK BULLET (P45194N.A)', cantidad: 0 },
    { nombre: 'O-RING PRECIX AS568B-023 (CS44106.A)', cantidad: 0 },
    { nombre: 'COVER, 3MVIC GREY COMPONENT (P63145A.A)', cantidad: 0 },
    { nombre: 'GARTRIDGE HOUSING 3MVIC2 GREEN CO (P63147A.A)', cantidad: 0 },
    { nombre: 'STEM MVIC 2 (P63146A.A)', cantidad: 0 },
    { nombre: 'SEPARATOR FLEECE MAIN (COMP11-00064A0)', cantidad: 0 },
    { nombre: 'SPRING MVIC2 (CS72189.A)', cantidad: 0 },
    { nombre: 'SPRING DIAPHRAGM (CS72190.A)', cantidad: 0 },
    { nombre: 'CAP DIAPHRAGM (P63148A.A)', cantidad: 0 },
    { nombre: 'CONVOLUTED TUBE (CS44107.E)', cantidad: 0 },
    { nombre: 'QUICK CONNECT HOUSING (P52199A.A)', cantidad: 0 },
    { nombre: 'Q/C O-RING #122 RED TFLN COAT (CS48190.A)', cantidad: 0 },
    { nombre: 'Q/C PERMANENT LOCKING RING (P53100A.D)', cantidad: 0 },
    { nombre: 'HEAT SHIELD, MY23 OIL SEPARATOR (CS74167.BB)', cantidad: 0 },
    { nombre: 'DIAPHRAGM, OIL SEPARATOR, 6.7L (CS74196.BB)', cantidad: 0 },
    { nombre: 'SNS ASY CRKC VEN TUB PRESS (ELEAF-01070A0)', cantidad: 0 },
    { nombre: 'M6 SELF TAPPING (W506857)', cantidad: 0 },
    { nombre: 'MAIN HOUSING BASE OIL SEPARATOR (SF-001650.B)', cantidad: 0 },
    { nombre: 'HOUSING TOP COVER OIL SEPARATOR (SF-001651.B)', cantidad: 0 },
    { nombre: 'MATRIX LBL SC3Q-6A785-AB (SF-002256)', cantidad: 0 },
    { nombre: 'FORD RETURNABLE GAYLORD, 48X45X34 IN (SB43 M536L)', cantidad: 0 },
    { nombre: 'FORD RETURNABLE PAD 44X41X0.197 (CS7967.A)', cantidad: 0 },
    { nombre: 'BAG 52X44X96 IN BLACK (CS1928)', cantidad: 0 },
    { nombre: 'SEPARATOR FLEECE STEM (COMP11-00066A0)', cantidad: 0 }
  ],
  VIEJO: [
    { nombre: 'LABEL 24 X 35 23700/ROLL (CS19103.REL)', cantidad: 0 },
    { nombre: 'HOUSING-OIL SEPARATOR (P39155A.P)', cantidad: 0 },
    { nombre: '6.7L OIL SEPARATOR SUB-ASSEMBLY (SA4291.B)', cantidad: 0 },
    { nombre: 'COVER-DIAPHRAGM (P39158A.D)', cantidad: 0 },
    { nombre: '1476 FT ROLL RIBBON 135849 (CS26185.REL)', cantidad: 0 },
    { nombre: 'UPPER COVER-OIL SEPARATOR (P39156A.F)', cantidad: 0 },
    { nombre: 'LBL BC3Q-6A785-EE AW473 (SA3697.B)', cantidad: 0 },
    { nombre: 'LOWER COVER-OIL SEPARATOR (P39157A.H)', cantidad: 0 },
    { nombre: 'SPLIT INSERT - LIMITER (CS48175.A)', cantidad: 0 },
    { nombre: 'HOUSING-CYCLONE (P39159A.E)', cantidad: 0 },
    { nombre: 'SPRING-DIAPHRAGM (CS44103.A)', cantidad: 0 },
    { nombre: 'COVER-CYCLONE HOUSING (P39160A.F)', cantidad: 0 },
    { nombre: 'DIAPHRAGM (VALD84-01041A0)', cantidad: 0 },
    { nombre: 'DRAIN PLATE (CS44104.C)', cantidad: 0 },
    { nombre: 'PIP SEAL FORD # BC3Q-6A632-AA (CS3539.A)', cantidad: 0 },
    { nombre: 'O-RING FORD BC3Q-8527-CA (CS44105.A)', cantidad: 0 },
    { nombre: 'ADAPTOR BODY (P39161A.B)', cantidad: 0 },
    { nombre: 'Q/C LOCK RING (P4262GY-APS.D)', cantidad: 0 },
    { nombre: 'PORT SENSOR - STANDEX (CS40194.D)', cantidad: 0 },
    { nombre: 'O-RING PRECIX AS568B-023 (CS44106.A)', cantidad: 0 },
    { nombre: 'Q/C O-RING RETAINER (P35170A.C)', cantidad: 0 },
    { nombre: 'CONVOLUTED TUBE (CS44107.E)', cantidad: 0 },
    { nombre: 'Q/C O-RING #122 RED TFLN COAT (CS48190.A)', cantidad: 0 },
    { nombre: 'CARTON RSC 45X42X27 IN (CS2920.REL)', cantidad: 0 },
    { nombre: 'PAD 44X41 IN - WITH NOMAR (CS4920.REL)', cantidad: 0 },
    { nombre: 'PALLET 48X45X5 IN HEAT TREATED (CS5907.REL)', cantidad: 0 },
    { nombre: 'BAG 52X44X96 IN BLACK (CS1928)', cantidad: 0 }
  ],
  CONCHA: [
    { nombre: 'PCV VALVE RETAINER (P30109A-MPC.B)', cantidad: 0 },
    { nombre: 'GREEN LABEL 24 X 35 (CS19103-4.A)', cantidad: 0 },
    { nombre: 'STRAIGHT CVT TUBE (CS60127.A)', cantidad: 0 },
    { nombre: 'OIL SEPARATOR WELDED-SUB ASSY (SA4032.B)', cantidad: 0 },
    { nombre: 'COVER-OIL SEPARATOR (P45187A.E)', cantidad: 0 },
    { nombre: '1476 FT ROLL RIBBON 135849 (CS266185.REL)', cantidad: 0 },
    { nombre: 'AISAN PCV VALVE (CS33186.REL)', cantidad: 0 },
    { nombre: 'O-RING (CS33183.B)', cantidad: 0 },
    { nombre: '.125 IMPACTOR PAD (CS51128.B)', cantidad: 0 },
    { nombre: 'FORMED CVT TUBE (989100.A)', cantidad: 0 },
    { nombre: 'GASKET GC1E-6B752-AA (CS3571.A)', cantidad: 0 },
    { nombre: 'COVER PLATE - OIL SEPARATOR (P45188A.B)', cantidad: 0 },
    { nombre: '1/2 X 1/2 QUICK CONNECT 90 DEG (CS46121.A)', cantidad: 0 },
    { nombre: 'COMPRESSION LIMITER (CS36161.MP)', cantidad: 0 },
    { nombre: 'CHECK BULLET (P45194N.A)', cantidad: 0 },
    { nombre: 'LBL LX6E-6A785-AA AW473 BARCODE (SA4068.A)', cantidad: 0 },
    { nombre: 'INTERNAL RETURNABLE TOTE, 24X20X12 (INT242012)', cantidad: 0 },
    { nombre: 'TUBE ASSEMBLY (H21645.A)', cantidad: 0 },
    { nombre: 'BAG, 25X15X30 IN. (CS952)', cantidad: 0 },
    { nombre: 'FORD RETURNABLE TOTE 24X15X7.5 (ST50 M536L)', cantidad: 0 },
    { nombre: 'BAG, 25X15X30 IN. (CS952)', cantidad: 0 },
    { nombre: 'FORD RETURNABLE LID 49X46X2 (SL19 M536L)', cantidad: 0 },
    { nombre: 'FORD RETURNABLE PALLET 48.5X46X6 (SP19 M536L)', cantidad: 0 }
  ],
  TAPÓN: [
    { nombre: 'OIL CAP (P33124A-MPC.C)', cantidad: 0 },
    { nombre: 'OIL CAP SEAL (CS36186.A)', cantidad: 0 }
  ],
  VASO: [
    { nombre: '??? (???)', cantidad: 0 },
    { nombre: '??? (???)', cantidad: 0 }
  ]
};

Object.entries(piezasEjemplo).forEach(([linea, piezas]) => {
  if (!localStorage.getItem('piezas_' + linea)) {
    localStorage.setItem('piezas_' + linea, JSON.stringify(piezas));
  }
});
//using gsap 3.11.4


// Variables para el nuevo menú principal

let novaresTitle = document.querySelector(".novaresTitle-skin");
let mainMenuButtons = document.querySelectorAll('.mainMenuButtons-skin .button-structure');
let background = document.querySelector(".background-skin");
let login = document.querySelector(".login-skin");
let bodyContainer = document.querySelector(".bodyContainer-skin");
let lineMenu = document.querySelector('.lineMenu-structure');
let lineaSeleccionadaTitulo = document.getElementById('lineaSeleccionadaTitulo');
let contadorPiezas = document.getElementById('contadorPiezas');
let listaPiezas = document.getElementById('listaPiezas');
let verListaBtn = document.getElementById('verListaBtn');
let volverBtn = document.getElementById('volverBtn');

// Estado de piezas por línea (en localStorage)
function getPiezasLinea(linea) {
  // Siempre devolver la lista completa de piezasEjemplo, sincronizando cantidades desde localStorage si existen
  const key = linea.toUpperCase();
  const ejemplo = piezasEjemplo[key] || [];
  const guardadas = JSON.parse(localStorage.getItem('piezas_' + key)) || [];
  // Sincronizar cantidades
  return ejemplo.map(ej => {
    const found = guardadas.find(g => g.nombre === ej.nombre);
    return found ? { ...ej, cantidad: found.cantidad } : { ...ej };
  });
}
function setPiezasLinea(linea, piezas) {
  // Solo guardar cantidades, nunca eliminar piezas
  const key = linea.toUpperCase();
  const ejemplo = piezasEjemplo[key] || [];
  // Mantener el orden y nombres del ejemplo, solo actualizar cantidades
  const piezasParaGuardar = ejemplo.map(ej => {
    const found = piezas.find(p => p.nombre === ej.nombre);
    return found ? { ...ej, cantidad: found.cantidad } : { ...ej };
  });
  localStorage.setItem('piezas_' + key, JSON.stringify(piezasParaGuardar));
}

// Mostrar menú principal

function mostrarMenuPrincipal() {
  // El video de fondo siempre debe mostrarse
  // background.style.display = "";
  login.style.display = "";
  lineMenu.style.display = "none";
  // Refrescar listas al mostrar menú principal
  if (typeof window.renderizarListaGeneral === 'function') window.renderizarListaGeneral();
  if (typeof window.renderizarPiezas === 'function') {
    const linea = localStorage.getItem('lineaSeleccionada');
    if (linea) window.renderizarPiezas(linea.toUpperCase());
  }
}

// Mostrar submenú de línea

function mostrarMenuLinea(linea) {
  // El video de fondo siempre debe mostrarse
  // background.style.display = "none";
  login.style.display = "none";
  lineMenu.style.display = "flex";
  lineaSeleccionadaTitulo.textContent = linea;
  renderizarPiezas(linea.toUpperCase());
  // Refrescar lista general también
  if (typeof window.renderizarListaGeneral === 'function') window.renderizarListaGeneral();
}

// Renderizar lista de piezas y contador
function renderizarPiezas(linea) {
  let piezas = getPiezasLinea(linea.toUpperCase());
  let total = piezas.reduce((acc, p) => acc + p.cantidad, 0);
  contadorPiezas.textContent = total;
  // Generar tabla con columnas: Nombre, No. Parte, Cantidad, Editar
  let tabla = document.createElement('table');
  tabla.style.width = '100%';
  tabla.style.borderCollapse = 'collapse';
  tabla.style.color = 'var(--fourth-color)';
  tabla.style.background = 'transparent';
  let thead = document.createElement('thead');
  thead.innerHTML = `
    <tr style="background:rgba(255,255,255,0.08);">
      <th style="padding:6px; border-bottom:1px solid var(--fourth-color); text-align:left;">Nombre</th>
      <th style="padding:6px; border-bottom:1px solid var(--fourth-color); text-align:left;">No. Parte</th>
      <th style="padding:6px; border-bottom:1px solid var(--fourth-color); text-align:left;">Cantidad</th>
      <th style="padding:6px; border-bottom:1px solid var(--fourth-color); text-align:center;">Editar</th>
    </tr>
  `;
  tabla.appendChild(thead);
  let tbody = document.createElement('tbody');
  piezas.forEach((pieza, idx) => {
    // Separar nombre y no. parte
    let nombre = pieza.nombre;
    let noParte = '';
    let match = nombre.match(/\(([^)]+)\)$/);
    if (match) {
      noParte = match[1];
      nombre = nombre.replace(/\s*\([^)]+\)$/, '');
    }
    let tr = document.createElement('tr');
    tr.innerHTML = `
      <td style="padding:6px; text-align:left;">${nombre}</td>
      <td style="padding:6px; text-align:left;">${noParte}</td>
      <td style="padding:6px; text-align:left; font-weight:bold;">${pieza.cantidad}</td>
      <td style="padding:6px; text-align:center;">
        <div class="lineMenu-piece-controls" style="display:inline-flex; gap:5px; margin:0;">
          <input type="number" min="1" value="1" style="width:38px; text-align:center; font-size:0.95rem;">
          <button data-accion="agregar" data-idx="${idx}" style="text-align:center; display:flex; align-items:center; justify-content:center;">
            <svg width="16" height="16" viewBox="0 0 18 18" fill="none" xmlns="http://www.w3.org/2000/svg" style="margin:0;">
              <rect x="7" y="3" width="4" height="12" rx="2" fill="#fff"/>
              <rect x="3" y="7" width="12" height="4" rx="2" fill="#fff"/>
            </svg>
          </button>
          <button data-accion="eliminar" data-idx="${idx}" style="text-align:center; display:flex; align-items:center; justify-content:center;">
            <svg width="16" height="16" viewBox="0 0 18 18" fill="none" xmlns="http://www.w3.org/2000/svg" style="margin:0;">
              <rect x="3" y="7" width="12" height="4" rx="2" fill="#fff"/>
            </svg>
          </button>
        </div>
      </td>
    `;
    tbody.appendChild(tr);
    // Eventos de control
    let controls = tr.querySelector('.lineMenu-piece-controls');
    controls.querySelector('[data-accion="agregar"]').onclick = () => {
      let input = controls.querySelector('input[type="number"]');
      let val = parseInt(input.value);
      if (!isNaN(val) && val > 0) {
        piezas[idx].cantidad += val;
        setPiezasLinea(linea.toUpperCase(), piezas);
        renderizarPiezas(linea.toUpperCase());
      }
    };
    controls.querySelector('[data-accion="eliminar"]').onclick = () => {
      let input = controls.querySelector('input[type="number"]');
      let val = parseInt(input.value);
      if (!isNaN(val) && val > 0) {
        piezas[idx].cantidad = Math.max(0, piezas[idx].cantidad - val);
        setPiezasLinea(linea.toUpperCase(), piezas);
        renderizarPiezas(linea.toUpperCase());
      }
    };
  });
  tabla.appendChild(tbody);
  listaPiezas.innerHTML = "";
  listaPiezas.appendChild(tabla);
  // Ya no se permite añadir nuevas piezas manualmente
}

// Evento para seleccionar línea y mostrar submenú
mainMenuButtons.forEach(btn => {
  btn.addEventListener('click', () => {
    const linea = btn.getAttribute('data-linea').toUpperCase();
    localStorage.setItem('lineaSeleccionada', linea);
    mostrarMenuLinea(linea);
  });
});

// Botón volver
if (volverBtn) {
  volverBtn.onclick = () => {
    mostrarMenuPrincipal();
  };
}

// Botón ver lista (puedes personalizar su función)
if (verListaBtn) {
  verListaBtn.onclick = () => {
    // Refrescar ambas listas antes de mostrar la general
    if (typeof window.renderizarListaGeneral === 'function') window.renderizarListaGeneral();
    if (typeof window.renderizarPiezas === 'function') {
      const linea = localStorage.getItem('lineaSeleccionada');
      if (linea) window.renderizarPiezas(linea.toUpperCase());
    }
  };
}


// >>> >>> >>> >>> >>> novaresTitle redireccion en nueva ventana <<< <<< <<< <<< <<<
novaresTitle.addEventListener("click", () => {
  window.open("https://www.novaresteam.com/", "_blank");
});



// Animación de los botones del menú principal
mainMenuButtons.forEach(button => {
  button.addEventListener("mouseover", () => {
    gsap.to(button, { duration: 0.3, backgroundColor: "#ffffff", color: "#000000", boxShadow: "#ffffff 0px 0px 10px 0px" });
  });
  button.addEventListener("mouseout", () => {
    gsap.to(button, { duration: 0.3, backgroundColor: "#000000", color: "#ffffff", boxShadow: "none" });
  });
});

/* >>> >>> >>> >>> >>> Animacion del los boton download <<< <<< <<< <<< <<< */
downloads.forEach(download => {
  download.addEventListener("mouseover", () => {
    gsap.to(download, { duration: 0.3, backgroundColor: "#ffffff", color: "#000000", boxShadow: "#ffffff 0px 0px 10px 0px" });
  });

  download.addEventListener("mouseout", () => {
    gsap.to(download, { duration: 0.3, backgroundColor: "#000000", color: "#ffffff", boxShadow: "none" });
  });
});


// (Inputs eliminados, no se requiere animación)


// (LoginTitle eliminado, no se requiere animación)


// (Login eliminado, no se requiere petición)


// Cerrar sesión (mantener funcionalidad si se usa en el siguiente menú)
if (endSession) {
  endSession.addEventListener("click", () => {
    localStorage.setItem("login", "false");
    window.location.reload();
  });
}

/* >>> >>> >>> >>> >>> Preloader <<< <<< <<< <<< <<< */
let preloader = document.getElementById('preloader-container');
let ocultarPreloader = () => {
  gsap.to(preloader, { duration: 0.5, opacity: 0, display: "none" });
}

window.addEventListener("load", ocultarPreloader);